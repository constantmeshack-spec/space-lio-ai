<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<style>
body {
    background-color: #121212;
    color: white;
    font-family: Arial, sans-serif;
    margin: 20px;
}

h1 { color: lightgreen; }
h2 { color: lightblue; margin-top: 40px; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #00FF00;
    padding: 10px;
    text-align: left;
}

th { background-color: #1a1a1a; }
td { background-color: #1e1e1e; }

a, button {
    background-color: darkgreen;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    text-decoration: none;
    margin-right: 6px;
    border: none;
    cursor: pointer;
}

a:hover, button:hover {
    background-color: #006400;
}

img {
    max-width: 150px;
    max-height: 100px;
    border: 1px solid #00FF00;
}

.actions {
    margin-bottom: 20px;
}
</style>
</head>

<body>

<h1>Admin Dashboard</h1>

<div class="actions">
    <a href="{{ url_for('add_task') }}">+ Add Task</a>
    <a href="{{ url_for('admin_dashboard') }}">Refresh Dashboard</a>
</div>

<!-- ================= TASK SUBMISSIONS ================= -->
<h2>Task Submissions</h2>

{% if submitted_tasks %}
<table>
<thead>
<tr>
    <th>ID</th>
    <th>Task</th>
    <th>User</th>
    <th>Phone</th>
    <th>File</th>
    <th>Reward</th>
    <th>Status</th>
    <th>Action</th>
</tr>
</thead>
<tbody>

{% for submission in submitted_tasks %}
<tr>
    <td>{{ submission.id }}</td>
    <td>{{ submission.task.title if submission.task else "N/A" }}</td>
    <td>{{ submission.user.full_name if submission.user else "N/A" }}</td>
    <td>{{ submission.user.phone if submission.user else "N/A" }}</td>
    <td>
        {% if submission.submission_file %}
        <a href="{{ url_for('uploaded_file', filename=submission.submission_file) }}" target="_blank">View / Download</a>
        {% else %}
        -
        {% endif %}
    </td>
    <td>{{ submission.task.reward if submission.task else 0 }}</td>
    <td>{{ "Approved" if submission.approved else "Pending" }}</td>
    <td>
        {% if not submission.approved %}
        <a href="{{ url_for('approve_task', submission_id=submission.id) }}">Approve</a>
        {% else %}
        âœ”
        {% endif %}
    </td>
</tr>
{% endfor %}

</tbody>
</table>
{% else %}
<p>No task submissions yet.</p>
{% endif %}

<!-- ================= MANAGE TASKS ================= -->
<h2>Manage Tasks</h2>

<table>
<thead>
<tr>
    <th>ID</th>
    <th>Title</th>
    <th>Type</th>
    <th>Reward</th>
    <th>Assigned To</th>
    <th>Actions</th>
</tr>
</thead>
<tbody>

{% for t in tasks %}
<tr>
    <td>{{ t.id }}</td>
    <td>{{ t.title }}</td>
    <td>{{ t.task_type }}</td>
    <td>{{ t.reward }}</td>
    <td>{{ t.assigned_to_id if t.assigned_to_id else "All Users" }}</td>
    <td>
        <a href="{{ url_for('edit_task', task_id=t.id) }}">Edit</a>
        <a href="{{ url_for('delete_task', task_id=t.id) }}"
           onclick="return confirm('Are you sure you want to delete this task?');">Delete</a>
    </td>
</tr>
{% endfor %}

</tbody>
</table>

<!-- ================= USERS PENDING VERIFICATION ================= -->
<h2>Users Pending Verification</h2>

<table>
<thead>
<tr>
    <th>Name</th>
    <th>Phone</th>
    <th>Verification</th>
    <th>View File</th>
    <th>Actions</th>
</tr>
</thead>
<tbody>

{% for u in users %}
{% if not u.verified %}
<tr>
    <td>{{ u.full_name }}</td>
    <td>{{ u.phone }}</td>
    <td>{{ "Uploaded" if u.verification_file else "None" }}</td>
    <td>
        {% if u.verification_file %}
        {% set file_name = u.verification_file.split('/')[-1] %}
        <a href="{{ url_for('verification_file', filename=file_name) }}" target="_blank">View</a>
        {% else %}
        -
        {% endif %}
    </td>
    <td>
        {% if u.verification_file %}
            <a href="{{ url_for('verify_user', user_id=u.id) }}">Approve</a>
            <a href="{{ url_for('reject_user', user_id=u.id) }}">Reject</a>
        {% else %}
            Waiting
        {% endif %}
    </td>
</tr>
{% endif %}
{% endfor %}

</tbody>
</table>

<!-- ================= VERIFIED USERS ================= -->
<h2>Verified Users</h2>

<table>
<thead>
<tr>
    <th>ID</th>
    <th>Name</th>
    <th>Phone</th>
    <th>Balance</th>
    <th>Affiliate?</th>
    <th>Referral Code</th>
    <th>Affiliate Earnings</th>
    <th>Admin</th>
</tr>
</thead>
<tbody>

{% for u in users %}
{% if u.verified %}
<tr>
    <td>{{ loop.index }}</td>
    <td>{{ u.full_name }}</td>
    <td>{{ u.phone }}</td>
    <td>{{ u.balance }}</td>
    <td>{{ "Yes" if u.is_affiliate else "No" }}</td>
    <td>{{ u.referral_code if u.referral_code else "-" }}</td>
    <td>{{ u.earnings }}</td>
    <td>{{ "Yes" if u.is_admin else "No" }}</td>
</tr>
{% endif %}
{% endfor %}

</tbody>
</table>

<!-- ================= AFFILIATE TRANSACTIONS ================= -->
<h2>Affiliate Transactions</h2>

{% if affiliate_transactions %}
<table>
<thead>
<tr>
    <th>ID</th>
    <th>User</th>
    <th>Type</th>
    <th>Amount</th>
    <th>Status</th>
    <th>Date</th>
</tr>
</thead>
<tbody>

{% for tx in affiliate_transactions %}
<tr>
    <td>{{ tx.id }}</td>
    <td>{{ tx.user.full_name if tx.user else "N/A" }}</td>
    <td>{{ tx.type }}</td>
    <td>{{ tx.amount }}</td>
    <td>{{ tx.status }}</td>
    <td>{{ tx.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
</tr>
{% endfor %}

</tbody>
</table>
{% else %}
<p>No affiliate transactions yet.</p>
{% endif %}

</body>
</html>
